--DROP PROCEDURE PSSCMLIB.PSM_POPUP_MRPPOMF_LIST;
  
CREATE PROCEDURE PSSCMLIB.PSM_POPUP_MRPPOMF_LIST ( 
	IN P_CURRENTPAGEINDEX INTEGER,
	IN P_PAGESIZE         INTEGER,
	IN P_STDATE           VARCHAR(8),
	IN P_EDDATE           VARCHAR(8),
	IN P_POM1180          VARCHAR(100),
	IN P_SAUP             VARCHAR(1),
	IN P_POMGUBN          VARCHAR(10))
	DYNAMIC RESULT SETS 2 
	LANGUAGE SQL 
	SPECIFIC PSSCMLIB.PSM_POPUP_MRPPOMF_LIST 
	NOT DETERMINISTIC 
	MODIFIES SQL DATA 
	CALLED ON NULL INPUT 
	SET OPTION  ALWBLK = *ALLREAD , 
	ALWCPYDTA = *OPTIMIZE , 
	COMMIT = *NONE , 
	DECRESULT = (31, 31, 00) , 
	DYNDFTCOL = *NO , 
	DYNUSRPRF = *USER , 
	SRTSEQ = *HEX   

P1 : BEGIN 
  
	DECLARE P_STNUM INTEGER ; 
	DECLARE P_FNNUM INTEGER ; 
  
	S1 : BEGIN  -- °ª ¼³Á¤ 
		SET P_STNUM = ( P_PAGESIZE * ( P_CURRENTPAGEINDEX - 1 ) ) + 1 ; 
		SET P_FNNUM = P_PAGESIZE * P_CURRENTPAGEINDEX ; 
	END S1 ; 

	LIST : BEGIN 

		DECLARE REFCURSOR CURSOR WITH RETURN FOR 

			WITH TABLE1 AS
			(
				SELECT
					POM1000,
					POM1010,
					POM1020,
					DIGITS(POM1030) AS POM1030,
					POM1000||'-'||POM1010||'-'||POM1020||'-'||DIGITS(POM1030) AS BUNHO, 
					SUBSTR(POM1100,1,4) || '-' || SUBSTR(POM1100,5,2) || '-' || SUBSTR(POM1100,7,2) AS POM1100,
					POM1180,
					CASE WHEN RRM1110 <> '' THEN SUBSTR(RRM1110,1,4) || '-' || SUBSTR(RRM1110,5,2) || '-' || SUBSTR(RRM1110,7,2) ELSE '' END AS RRM1110,
					 PON1050,
					 PON1100,
					 CASE WHEN SUBSTR(PON1040,1,1) = 'T' THEN 'T' ELSE
					 CASE WHEN SUBSTR(PON1040,1,1) = 'S' THEN 'S' ELSE
					 CASE WHEN PON1040 = 'E10100' THEN 'T' ELSE
					 CASE WHEN PON1040 = 'E10200' THEN 'S' ELSE
					 CASE WHEN PON1040 = 'D10000' THEN 'D' ELSE
					 CASE WHEN SUBSTR(PON1040,1,1) = 'A' THEN 'A' ELSE '' END END END END END END AS SAUP,
					SUBSTR(PON1620,2,10) AS PON1620,
					(
					 SELECT FXC3DESC FROM TYSCMLIB.ACFIXCLASS3
					 WHERE   SUBSTR(PON1620,2,1) = FXC3SAUP
					 AND     SUBSTR(PON1620,3,2) = FXC3BCODE
					 AND     SUBSTR(PON1620,5,4) = FXC3MCODE
					 AND     SUBSTR(PON1620,9,3) = FXC3SCODE
					) AS PON1620NM,
					CASE WHEN POM1500 <> '' THEN 'Y' ELSE 'N' END AS POMGUBN
					FROM TYSCMLIB.MRPPOMF AS POMF 
				LEFT OUTER JOIN TYSCMLIB.MRPPONF AS PONF
				ON    POM1000 = PON1000
				AND   POM1010 = PON1010
				AND   POM1020 = PON1020
				AND   POM1030 = PON1030
				LEFT OUTER JOIN TYSCMLIB.MRPRRMF RRMF
				ON   RRM1120 = POM1000||POM1010||POM1020||DIGITS(POM1030)
				LEFT OUTER JOIN TYSCMLIB.MRPJPMF JPMF
				ON     JPMF.Z105000 = SUBSTR(PONF.PON1050,1,1)
				AND   JPMF.Z105001 = SUBSTR(PONF.PON1050,2,3)
				AND   JPMF.Z105002 = SUBSTR(PONF.PON1050,5,3)
				AND   JPMF.Z105003 = SUBSTR(PONF.PON1050,8,5)
				WHERE POM1010 = 'O'
				AND    POM1020 BETWEEN P_STDATE AND P_EDDATE
				AND    SUBSTR(PON1620,3,2) IN ('20','30','40', '90')
				AND    (CASE WHEN P_POM1180 = '' THEN '' ELSE POM1180 END)
				=
				       (CASE WHEN P_POM1180 = '' THEN '' ELSE P_POM1180 END)
				GROUP BY POM1000, POM1010, POM1020, POM1030, POM1100, POM1180, RRM1110, PON1100, PON1040, PON1620, PON1050, POM1500 
				ORDER BY POM1000, POM1010, POM1020, POM1030
			),

			DETAIL AS 
			( 
				SELECT
					ROW_NUMBER() OVER(ORDER BY POM1000, POM1010, POM1020, POM1030) AS ROWNO,
					POM1000,
					POM1010,
					POM1020,
					POM1030,
					BUNHO, 
					POM1100,
					POM1180,
					RRM1110,
					T1.PON1050 AS JEPUM1,
					T1.PON1100,
					JPMF.Z105013 AS Z1050131,
					VEND.VNSANGHO,
					PONF.PON1150,
					PONF.PON1170,
					PONF.PON1040,
					T1.SAUP,
					T1.PON1620,
					T1.PON1620NM
				FROM TABLE1 T1
				LEFT OUTER JOIN TYSCMLIB.MRPJPMF JPMF
				ON     JPMF.Z105000 = SUBSTR(T1.PON1050,1,1)
				AND   JPMF.Z105001 = SUBSTR(T1.PON1050,2,3)
				AND   JPMF.Z105002 = SUBSTR(T1.PON1050,5,3)
				AND   JPMF.Z105003 = SUBSTR(T1.PON1050,8,5)
				LEFT OUTER JOIN TYSCMLIB.AVENDMF AS VEND
				ON   T1.PON1100  = VEND.VNCODE
				LEFT OUTER JOIN TYSCMLIB.MRPPONF AS PONF
				ON    PONF.PON1000 = T1.POM1000
				AND   PONF.PON1010 = T1.POM1010
				AND   PONF.PON1020 = T1.POM1020
				AND   PONF.PON1030 = T1.POM1030
				AND   PONF.PON1050 = T1.PON1050
				WHERE SAUP IN ( SELECT * FROM TABLE(TYSCMLIB.SF_GB_RevColRow(CAST(P_SAUP AS VARCHAR(50)), ',')) AS InTable )
				AND   POMGUBN IN ( SELECT * FROM TABLE(TYSCMLIB.SF_GB_RevColRow(CAST(P_POMGUBN AS VARCHAR(50)), ',')) AS InTable )
			) 

			SELECT 
			* 
			FROM DETAIL 
			WHERE ROWNO BETWEEN P_STNUM AND P_FNNUM;

		OPEN REFCURSOR;

	END LIST;

	PAGING : BEGIN 

		DECLARE REFCURSOR2 CURSOR WITH RETURN FOR

			WITH TABLE1 AS
			(
				SELECT
					POM1000,
					POM1010,
					POM1020,
					DIGITS(POM1030) AS POM1030,
					POM1000||'-'||POM1010||'-'||POM1020||'-'||DIGITS(POM1030) AS BUNHO, 
					SUBSTR(POM1100,1,4) || '-' || SUBSTR(POM1100,5,2) || '-' || SUBSTR(POM1100,7,2) AS POM1100,
					POM1180,
					CASE WHEN RRM1110 <> '' THEN SUBSTR(RRM1110,1,4) || '-' || SUBSTR(RRM1110,5,2) || '-' || SUBSTR(RRM1110,7,2) ELSE '' END AS RRM1110,
					 PON1050,
					 PON1100,
					 CASE WHEN SUBSTR(PON1040,1,1) = 'T' THEN 'T' ELSE
					 CASE WHEN SUBSTR(PON1040,1,1) = 'S' THEN 'S' ELSE
					 CASE WHEN PON1040 = 'E10100' THEN 'T' ELSE
					 CASE WHEN PON1040 = 'E10200' THEN 'S' ELSE
					 CASE WHEN PON1040 = 'D10000' THEN 'D' ELSE
					 CASE WHEN SUBSTR(PON1040,1,1) = 'A' THEN 'A' ELSE '' END END END END END END AS SAUP,
					SUBSTR(PON1620,2,10) AS PON1620,
					(
					 SELECT FXC3DESC FROM TYSCMLIB.ACFIXCLASS3
					 WHERE   SUBSTR(PON1620,2,1) = FXC3SAUP
					 AND     SUBSTR(PON1620,3,2) = FXC3BCODE
					 AND     SUBSTR(PON1620,5,4) = FXC3MCODE
					 AND     SUBSTR(PON1620,9,3) = FXC3SCODE
					) AS PON1620NM,
					CASE WHEN POM1500 <> '' THEN 'Y' ELSE 'N' END AS POMGUBN
					FROM TYSCMLIB.MRPPOMF AS POMF 
				LEFT OUTER JOIN TYSCMLIB.MRPPONF AS PONF
				ON    POM1000 = PON1000
				AND   POM1010 = PON1010
				AND   POM1020 = PON1020
				AND   POM1030 = PON1030
				LEFT OUTER JOIN TYSCMLIB.MRPRRMF RRMF
				ON   RRM1120 = POM1000||POM1010||POM1020||DIGITS(POM1030)
				LEFT OUTER JOIN TYSCMLIB.MRPJPMF JPMF
				ON     JPMF.Z105000 = SUBSTR(PONF.PON1050,1,1)
				AND   JPMF.Z105001 = SUBSTR(PONF.PON1050,2,3)
				AND   JPMF.Z105002 = SUBSTR(PONF.PON1050,5,3)
				AND   JPMF.Z105003 = SUBSTR(PONF.PON1050,8,5)
				WHERE POM1010 = 'O'
				AND    POM1020 BETWEEN P_STDATE AND P_EDDATE
				AND    SUBSTR(PON1620,3,2) IN ('20','30','40', '90')
				AND    (CASE WHEN P_POM1180 = '' THEN '' ELSE POM1180 END)
				=
				       (CASE WHEN P_POM1180 = '' THEN '' ELSE P_POM1180 END)
				GROUP BY POM1000, POM1010, POM1020, POM1030, POM1100, POM1180, RRM1110, PON1100, PON1040, PON1620, PON1050, POM1500 
				ORDER BY POM1000, POM1010, POM1020, POM1030
			),

			DETAIL AS
			(
				SELECT
					POM1000,
					POM1010,
					POM1020,
					POM1030,
					BUNHO, 
					POM1100,
					POM1180,
					RRM1110,
					T1.PON1050 AS JEPUM1,
					T1.PON1100,
					JPMF.Z105013 AS Z1050131,
					VEND.VNSANGHO,
					PONF.PON1150,
					PONF.PON1170,
					PONF.PON1040,
					T1.SAUP,
					T1.PON1620,
					T1.PON1620NM
				FROM TABLE1 T1
				LEFT OUTER JOIN TYSCMLIB.MRPJPMF JPMF
				ON     JPMF.Z105000 = SUBSTR(T1.PON1050,1,1)
				AND   JPMF.Z105001 = SUBSTR(T1.PON1050,2,3)
				AND   JPMF.Z105002 = SUBSTR(T1.PON1050,5,3)
				AND   JPMF.Z105003 = SUBSTR(T1.PON1050,8,5)
				LEFT OUTER JOIN TYSCMLIB.AVENDMF AS VEND
				ON   T1.PON1100  = VEND.VNCODE
				LEFT OUTER JOIN TYSCMLIB.MRPPONF AS PONF
				ON    PONF.PON1000 = T1.POM1000
				AND   PONF.PON1010 = T1.POM1010
				AND   PONF.PON1020 = T1.POM1020
				AND   PONF.PON1030 = T1.POM1030
				AND   PONF.PON1050 = T1.PON1050
				WHERE SAUP IN ( SELECT * FROM TABLE(TYSCMLIB.SF_GB_RevColRow(CAST(P_SAUP AS VARCHAR(50)), ',')) AS InTable )
				AND   POMGUBN IN ( SELECT * FROM TABLE(TYSCMLIB.SF_GB_RevColRow(CAST(P_POMGUBN AS VARCHAR(50)), ',')) AS InTable )
				ORDER BY POM1000, POM1010, POM1020, POM1030
			)

			SELECT COUNT(*) AS TOTALCOUNT
			FROM DETAIL;

		OPEN REFCURSOR2;

	END PAGING;
END;

GRANT ALTER , EXECUTE
ON SPECIFIC PROCEDURE PSSCMLIB.PSM_POPUP_MRPPOMF_LIST
TO KSGPDM WITH GRANT OPTION;